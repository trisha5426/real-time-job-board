<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Connect: Professional Networking and Job Portal MVP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc; /* Light background */
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .btn-primary {
            background-color: #1e40af; /* Darker blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* Lighter blue on hover */
        }
        /* Mobile-first: Ensure main content takes up full height */
        #app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af',
                        'secondary-gray': '#6b7280',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">

    <div id="app-container" class="max-w-7xl mx-auto w-full">

        <header id="navbar" class="bg-white shadow-lg sticky top-0 z-10 hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <span class="text-2xl font-bold text-primary-blue cursor-pointer" onclick="navigateTo('dashboard')">JobConnect</span>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4 text-sm sm:text-base">
                        <button onclick="navigateTo('notifications')" class="p-2 rounded-full text-secondary-gray hover:text-primary-blue transition duration-150 relative">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span id="notification-count-badge" class="absolute top-1 right-1 h-2 w-2 rounded-full bg-red-600 hidden"></span>
                        </button>
                        
                        <button onclick="navigateTo('jobs')" class="text-secondary-gray hover:text-primary-blue transition duration-150 p-2 rounded-lg hidden sm:inline">Job Listings</button>
                        <button onclick="navigateTo('profile')" class="text-secondary-gray hover:text-primary-blue transition duration-150 p-2 rounded-lg hidden sm:inline">Profile</button>
                        <button onclick="navigateTo('about')" class="text-secondary-gray hover:text-primary-blue transition duration-150 p-2 rounded-lg hidden sm:inline">About Us</button>
                        <button onclick="navigateTo('contact')" class="text-secondary-gray hover:text-primary-blue transition duration-150 p-2 rounded-lg hidden sm:inline">Contact Us</button>

                        <button onclick="navigateTo('postJob')" class="text-white bg-indigo-600 hover:bg-indigo-700 font-semibold py-2 px-3 sm:px-4 rounded-lg shadow transition duration-150 whitespace-nowrap text-sm">Post Job</button>

                        <button onclick="handleSignOut()" class="text-red-500 hover:text-red-700 transition duration-150 p-2 rounded-lg border border-red-500 hover:border-red-700 text-sm">Sign Out</button>
                    </div>
                </div>
            </div>
        </header>

        <main id="content-area" class="flex-grow p-4 sm:p-8">
        </main>

        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-t-primary-blue border-gray-200"></div>
            <p class="ml-4 text-white text-lg">Loading...</p>
        </div>

        <div id="apply-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-40 flex items-center justify-center hidden">
            <div class="bg-white p-8 rounded-xl card max-w-lg w-full m-4">
                <h3 id="modal-title" class="text-2xl font-semibold text-primary-blue mb-4">Confirm Application</h3>
                <p id="apply-job-title" class="text-lg font-medium mb-4"></p>
                <p id="apply-instruction" class="text-secondary-gray mb-6">Are you sure you want to apply for this position? We will submit your profile details and resume link.</p>
                <div id="apply-message" class="text-green-600 font-semibold text-lg mb-4 hidden"></div>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-btn" onclick="hideApplyModal()" class="text-secondary-gray border border-gray-300 py-2 px-5 rounded-lg shadow-md hover:bg-gray-100 transition duration-150">Cancel</button>
                    <button id="confirm-apply-btn" onclick="submitApplication()" class="btn-primary py-2 px-5 rounded-lg shadow-md hover:shadow-lg transition duration-150">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('Debug');

        // Global Firebase Configuration (Mandatory Setup)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'job-connect-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        window.userId = null;
        let isLoggedIn = false;
        let currentPage = 'login'; // Initial UI state
        
        // Global State for Jobs and User Profile
        window.jobs = []; 
        window.userProfile = { name: '', title: '', resumeLink: '', summary: '' };
        // ADDED: salaryRange filter state
        let currentJobFilter = { search: '', location: 'All', salaryRange: 'All' }; 
        let currentJobToApply = null; // Store job details for the modal

        // --- Utility Functions ---

        const showLoading = (show) => {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        };
        
        /**
         * Parses a salary string (e.g., "$120K+", "$80K", "Negotiable") into a minimum annual salary in thousands (K).
         * Used for numerical filtering.
         * @param {string} salary
         * @returns {number} Minimum salary in thousands (e.g., 120 for $120K)
         */
        const parseSalaryToMinK = (salary) => {
            if (!salary || salary.toLowerCase() === 'negotiable') return 0;
            // Matches $XXXK and captures XXX
            const match = salary.match(/\$(\d+)K/i); 
            return match ? parseInt(match[1], 10) : 0;
        };

        // --- Core App Setup and Authentication ---
        async function setupFirebase() {
            try {
                showLoading(true);

                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    await new Promise(resolve => {
                        const unsubscribe = onAuthStateChanged(auth, async (user) => {
                            if (user) {
                                window.userId = user.uid;
                                isLoggedIn = true;
                                // Start listening to jobs once authenticated
                                setupJobListener(); 
                                // Fetch user profile
                                await fetchUserProfile();
                                setUIState('dashboard');
                            } else {
                                // Attempt sign in with token or fallback to Anonymous Sign In
                                if (initialAuthToken) {
                                    try {
                                        await signInWithCustomToken(auth, initialAuthToken);
                                    } catch (error) {
                                        console.error("Custom Token Sign In Failed:", error);
                                        await signInAnonymously(auth);
                                    }
                                } else {
                                    await signInAnonymously(auth);
                                }
                            }
                            unsubscribe();
                            resolve();
                        });
                    });
                } else {
                    console.warn("Firebase config not available. Running in UI simulation mode.");
                    // Fallback simulated user ID for UI-only mode
                    window.userId = "simulated-user-guest";
                    isLoggedIn = true; // Assume logged in for UI demo purposes
                    setUIState('dashboard');
                    // UPDATED: Added a job for the 'Low' salary range
                    window.jobs = [
                        { id: 'job1', title: 'Senior Developer', company: 'Tech Corp', location: 'Remote', salary: '$120K+', description: 'Build scalable applications with React/Node.js. Must have 5+ years experience and be proficient in cloud technologies (AWS/Azure). Great benefits and flexible hours.', timestamp: Date.now() - 3600000 },
                        { id: 'job2', title: 'UX Designer', company: 'Design Studio', location: 'NY', salary: '$80K', description: 'Design user-friendly interfaces for a new mobile app. Experience with Figma is required. Must be able to conduct user interviews.', timestamp: Date.now() - 7200000 },
                        { id: 'job3', title: 'Marketing Manager', company: 'Brand Innovators', location: 'London', salary: '$95K', description: 'Lead digital marketing campaigns and manage a small team. Focus on SEO/SEM and content strategy.', timestamp: Date.now() - 10800000 },
                        { id: 'job4', title: 'Junior Analyst Internship', company: 'Startup Co', location: 'Remote', salary: '$50K', description: 'Entry-level position analyzing market trends and assisting senior staff.', timestamp: Date.now() - 12800000 }
                    ];
                }
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                setUIState('login');
            } finally {
                showLoading(false);
            }
        }

        // --- Authentication Handlers ---

        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password || !auth) return;

            showLoading(true);
            try {
                // Try to sign in
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    // If user not found, try to sign up/create the user
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        // Using custom alert instead of window.alert()
                        document.getElementById('login-error-message').textContent = "Account created successfully! You are now logged in.";
                        document.getElementById('login-error-message').classList.remove('hidden', 'text-red-500');
                        document.getElementById('login-error-message').classList.add('text-green-600');
                    } catch (signUpError) {
                        document.getElementById('login-error-message').textContent = `Sign Up Failed: ${signUpError.message}`;
                        document.getElementById('login-error-message').classList.remove('hidden');
                        document.getElementById('login-error-message').classList.add('text-red-500');
                    }
                } else {
                    document.getElementById('login-error-message').textContent = `Login Failed: ${error.message}`;
                    document.getElementById('login-error-message').classList.remove('hidden');
                    document.getElementById('login-error-message').classList.add('text-red-500');
                }
            } finally {
                showLoading(false);
            }
        };

        window.handleSignOut = async () => {
            if (!auth) {
                // Simulated sign out for UI-only mode
                isLoggedIn = false;
                window.userId = null;
                setUIState('login');
                return;
            }
            try {
                await signOut(auth);
                window.userId = null;
                isLoggedIn = false;
                setUIState('login');
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        };


        // --- Profile Management ---

        const fetchUserProfile = async () => {
            if (!db || !window.userId) return;
            // Path: artifacts/{appId}/users/{userId}/profile/details
            const userDocRef = doc(db, "artifacts", appId, "users", window.userId, "profile", "details");
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    window.userProfile = docSnap.data();
                    console.log("Profile fetched:", window.userProfile);
                } else {
                    console.log("No profile found, using defaults.");
                }
            } catch (error) {
                console.error("Error fetching profile:", error);
            }
        };

        window.saveProfile = async () => {
            const name = document.getElementById('p-name').value;
            const title = document.getElementById('p-title').value;
            const resumeLink = document.getElementById('p-resume').value;
            const summary = document.getElementById('p-summary').value;

            window.userProfile = { name, title, resumeLink, summary };
            document.getElementById('save-message').classList.remove('hidden');
            setTimeout(() => document.getElementById('save-message').classList.add('hidden'), 3000);

            if (!db || !window.userId) return; // Skip Firestore if not configured

            showLoading(true);
            try {
                // Path: artifacts/{appId}/users/{userId}/profile/details
                const userDocRef = doc(db, "artifacts", appId, "users", window.userId, "profile", "details");
                await setDoc(userDocRef, window.userProfile, { merge: true });
                console.log("Profile saved to Firestore!");
            } catch (error) {
                console.error("Error saving profile:", error);
                // Using console log instead of alert
                console.log("Failed to save profile to database."); 
            } finally {
                showLoading(false);
            }
        };

        // --- Job Handlers ---

        window.handleJobPost = async (event) => {
            event.preventDefault(); // Prevent form submission default action
            
            const title = document.getElementById('job-title').value;
            const company = document.getElementById('company-name').value;
            const location = document.getElementById('job-location').value;
            const salary = document.getElementById('salary-range').value || 'Negotiable';
            const description = document.getElementById('job-description').value;

            if (!title || !company || !location || !description) {
                console.log("Please fill in all required job fields.");
                return;
            }

            const newJob = {
                title,
                company,
                location,
                salary,
                description,
                timestamp: Date.now(),
                postedBy: window.userId,
            };

            document.getElementById('post-message').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('post-message').classList.add('hidden');
                // Navigate to the jobs page after successful post (simulated/actual)
                navigateTo('jobs'); 
            }, 1000);

            if (!db || !appId) return; // Skip Firestore if not configured

            showLoading(true);
            try {
                // Firestore path: artifacts/{appId}/public/data/jobs/{jobId}
                const jobsCollection = collection(db, "artifacts", appId, "public", "data", "jobs");
                await addDoc(jobsCollection, newJob);
                console.log("Job posted successfully to Firestore!");
                // Clear form fields
                event.target.reset();
            } catch (error) {
                console.error("Error posting job:", error);
                console.log("Failed to post job to database.");
            } finally {
                showLoading(false);
            }
        };
        
        window.showApplyModal = (jobId, jobTitle) => {
            currentJobToApply = window.jobs.find(j => j.id === jobId);
            if (!currentJobToApply) return;
            
            document.getElementById('apply-job-title').textContent = currentJobToApply.title + ' at ' + currentJobToApply.company;
            document.getElementById('apply-modal').classList.remove('hidden');
            document.getElementById('apply-message').classList.add('hidden');
            document.getElementById('apply-message').classList.remove('text-red-600');
            document.getElementById('apply-message').classList.add('text-green-600');
            document.getElementById('apply-instruction').classList.remove('hidden');
            document.getElementById('confirm-apply-btn').classList.remove('hidden');
            document.getElementById('cancel-btn').textContent = 'Cancel';
        };

        window.hideApplyModal = () => {
            document.getElementById('apply-modal').classList.add('hidden');
            currentJobToApply = null;
        };

        window.submitApplication = async () => {
            if (!currentJobToApply || !window.userId) return;
            
            if (!window.userProfile.resumeLink) {
                 // Simple validation
                 console.log("Please update your profile with a Resume Link before applying.");
                 hideApplyModal();
                 navigateTo('profile');
                 return;
            }

            const applicationData = {
                jobId: currentJobToApply.id,
                jobTitle: currentJobToApply.title,
                applicantId: window.userId,
                timestamp: Date.now(),
                // Send profile data stored in global state
                applicantName: window.userProfile.name || 'Anonymous User',
                applicantTitle: window.userProfile.title || 'Job Seeker',
                resumeLink: window.userProfile.resumeLink,
            };

            // Display success message and disable button
            document.getElementById('apply-instruction').classList.add('hidden');
            document.getElementById('confirm-apply-btn').classList.add('hidden');
            document.getElementById('apply-message').textContent = 'Application submitted successfully! (Simulated)';
            document.getElementById('apply-message').classList.remove('hidden');
            document.getElementById('cancel-btn').textContent = 'Close';
            
            if (!db || !appId) return; // Skip Firestore if not configured

            showLoading(true);
            try {
                // Firestore path: artifacts/{appId}/public/data/applications/{applicationId}
                const applicationsCollection = collection(db, "artifacts", appId, "public", "data", "applications");
                await addDoc(applicationsCollection, applicationData);
                console.log("Application submitted to Firestore!");
            } catch (error) {
                console.error("Error submitting application:", error);
                document.getElementById('apply-message').textContent = 'Application failed to submit to database.';
                document.getElementById('apply-message').classList.remove('text-green-600');
                document.getElementById('apply-message').classList.add('text-red-600');
            } finally {
                showLoading(false);
            }
        };


        // --- Firestore Listeners ---

        const setupJobListener = () => {
            if (!db || !appId) return;

            // Firestore path: artifacts/{appId}/public/data/jobs
            const jobsCollection = collection(db, "artifacts", appId, "public", "data", "jobs");
            const q = query(jobsCollection); 

            onSnapshot(q, (snapshot) => {
                window.jobs = [];
                snapshot.forEach((doc) => {
                    // Add document ID and data to the global array
                    window.jobs.push({ id: doc.id, ...doc.data() });
                });
                // Sort by timestamp (most recent first)
                window.jobs.sort((a, b) => b.timestamp - a.timestamp); // Use numbers for direct comparison
                
                // Re-render the job listings if the user is currently viewing them
                if (currentPage === 'jobs') {
                    renderJobs();
                }
                // Also update dashboard widgets
                if (currentPage === 'dashboard') {
                    renderDashboard();
                }
                console.log("Jobs updated from Firestore:", window.jobs.length);
            }, (error) => {
                console.error("Error listening to job collection:", error);
                // Fallback to empty array if connection fails
                window.jobs = [];
                if (currentPage === 'jobs') {
                    renderJobs();
                }
            });
        };


        // --- UI Rendering Functions ---

        const renderLogin = () => {
            document.getElementById('navbar').classList.add('hidden');
            document.getElementById('content-area').innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[calc(100vh-64px)] p-4">
                    <div class="bg-white p-8 sm:p-10 rounded-xl card max-w-md w-full text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-primary-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.513 23.513 0 0112 15c-3.185 0-6.279-.661-9-1.745M16 16v1a2 2 0 002 2h4a2 2 0 002-2v-1M6 16v1a2 2 0 002 2h4a2 2 0 002-2v-1M6 6v1a2 2 0 002 2h4a2 2 0 002-2v-1M16 6v1a2 2 0 002 2h4a2 2 0 002-2v-1" />
                        </svg>
                        <h2 class="text-3xl font-extrabold text-gray-900 mt-4 mb-2">Welcome to JobConnect</h2>
                        <p class="text-secondary-gray mb-8">The professional networking and job portal MVP.</p>

                        <div class="space-y-4">
                            <input id="email" type="email" value="user@example.com" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                            <input id="password" type="password" value="password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                        </div>
                        <p id="login-error-message" class="mt-4 text-sm text-red-500 hidden"></p>
                        <button onclick="handleLogin()" class="mt-6 w-full btn-primary py-3 rounded-lg shadow-md hover:shadow-lg transition duration-150 font-semibold text-lg">
                            Log In / Sign Up
                        </button>
                    </div>
                </div>
            `;
        };

        const renderDashboard = () => {
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('content-area').innerHTML = `
                <div class="p-4 sm:p-6 lg:p-8">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Dashboard Overview</h1>
                    <p class="text-secondary-gray mb-8">Welcome back, Job Seeker! Your User ID (for collaboration) is: <span class="font-mono bg-gray-200 px-2 py-1 rounded-md text-sm">${window.userId || 'Not Authenticated'}</span></p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl card border-l-4 border-primary-blue">
                            <p class="text-sm text-secondary-gray">Jobs Applied (Simulated)</p>
                            <p class="text-3xl font-bold text-gray-900 mt-1">42</p>
                            <span class="text-sm text-green-600">â†‘ 1 New This Week</span>
                        </div>

                        <div class="bg-white p-6 rounded-xl card border-l-4 border-green-600 cursor-pointer hover:bg-gray-50" onclick="navigateTo('profile')">
                            <p class="text-sm text-secondary-gray">Profile Completion</p>
                            <p class="text-3xl font-bold text-gray-900 mt-1">75%</p>
                            <span class="text-sm text-primary-blue">Click to complete!</span>
                        </div>

                        <div class="bg-white p-6 rounded-xl card border-l-4 border-yellow-600 cursor-pointer hover:bg-gray-50" onclick="navigateTo('jobs')">
                            <p class="text-sm text-secondary-gray">Total Open Jobs</p>
                            <p class="text-3xl font-bold text-gray-900 mt-1">${window.jobs.length}</p>
                            <span class="text-sm text-yellow-600">Click to explore!</span>
                        </div>
                    </div>

                    <div class="mt-10">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Featured Job</h2>
                        <div class="bg-white p-6 rounded-xl card space-y-4">
                            ${window.jobs.length > 0 ? `
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3">
                                    <div>
                                        <p class="font-semibold text-primary-blue">${window.jobs[0].title}</p>
                                        <p class="text-sm text-secondary-gray">${window.jobs[0].company} | ${window.jobs[0].location}</p>
                                    </div>
                                    <button onclick="showApplyModal('${window.jobs[0].id}', '${window.jobs[0].title}')" class="mt-2 sm:mt-0 text-white bg-primary-blue hover:bg-blue-700 py-2 px-4 rounded-lg text-sm">View & Apply</button>
                                </div>
                            ` : '<p class="text-center text-secondary-gray">No featured jobs available. Post one now!</p>'}
                            
                        </div>
                    </div>
                </div>
            `;
        };

        const renderProfile = () => {
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('content-area').innerHTML = `
                <div class="p-4 sm:p-6 lg:p-8">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Profile Management</h1>
                    <p class="text-secondary-gray mb-8">Update your professional details and provide your resume link.</p>

                    <div class="bg-white p-6 rounded-xl card">
                        <form onsubmit="event.preventDefault(); saveProfile()">
                            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                                <div>
                                    <label for="p-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="p-name" value="${window.userProfile.name || 'Jane Doe'}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                                </div>
                                <div>
                                    <label for="p-title" class="block text-sm font-medium text-gray-700">Current Title</label>
                                    <input type="text" id="p-title" value="${window.userProfile.title || 'Software Engineer'}" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="p-resume" class="block text-sm font-medium text-gray-700">Resume Link (Add Resume)</label>
                                    <input type="url" id="p-resume" value="${window.userProfile.resumeLink || 'https://docs.google.com/my-resume'}" placeholder="e.g., Google Drive link or personal site link" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                                    <p class="mt-1 text-xs text-secondary-gray">This link will be submitted when you click 'Apply Now'.</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="p-summary" class="block text-sm font-medium text-gray-700">Professional Summary</label>
                                    <textarea id="p-summary" rows="4" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>${window.userProfile.summary || 'Dynamic and driven engineer with 5 years of experience in full-stack development. Seeking new challenges in Agile environments.'}</textarea>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end">
                                <button type="submit" class="btn-primary py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 font-semibold">
                                    Save Profile
                                </button>
                            </div>
                        </form>
                    </div>
                    <div id="save-message" class="mt-4 text-green-600 font-semibold hidden">Profile saved successfully!</div>
                </div>
            `;
        };

        // NEW FUNCTION: Clear all filters
        const clearJobFilters = () => {
            // Reset the state
            currentJobFilter.search = '';
            currentJobFilter.location = 'All';
            currentJobFilter.salaryRange = 'All'; // Reset salary filter

            // Reset the UI inputs
            const searchInput = document.getElementById('search-input');
            const locationFilter = document.getElementById('location-filter');
            const salaryFilter = document.getElementById('salary-filter');

            if (searchInput) searchInput.value = '';
            if (locationFilter) locationFilter.value = 'All';
            if (salaryFilter) salaryFilter.value = 'All';

            // Trigger the main filter function to show all jobs
            filterJobs();
        }
        window.clearJobFilters = clearJobFilters; // Expose to global scope for HTML onclick


        // Job Filtering Logic (UPDATED to include Salary)
        const filterJobs = () => {
            // Read current filter values (or use the state if UI elements don't exist yet)
            const searchInput = document.getElementById('search-input');
            const locationSelect = document.getElementById('location-filter');
            const salarySelect = document.getElementById('salary-filter'); // NEW

            const searchText = (searchInput?.value || currentJobFilter.search).toLowerCase();
            const locationFilter = (locationSelect?.value || currentJobFilter.location);
            const salaryFilter = (salarySelect?.value || currentJobFilter.salaryRange); // NEW

            currentJobFilter.search = searchText;
            currentJobFilter.location = locationFilter;
            currentJobFilter.salaryRange = salaryFilter; // NEW

            const filtered = window.jobs.filter(job => {
                // 1. Text Search Filter
                const jobTitle = job.title?.toLowerCase() || '';
                const jobCompany = job.company?.toLowerCase() || '';
                const jobDescription = job.description?.toLowerCase() || '';
                const jobLocation = job.location?.toLowerCase() || '';

                const textMatch = jobTitle.includes(searchText) || 
                                          jobCompany.includes(searchText) || 
                                          jobDescription.includes(searchText);

                // 2. Location Filter
                const locationMatch = locationFilter === 'All' || jobLocation.includes(locationFilter.toLowerCase());

                // 3. Salary Range Filter (NEW)
                const salaryFilterMatch = () => {
                    if (salaryFilter === 'All') return true;
                    const jobSalaryMinK = parseSalaryToMinK(job.salary);

                    if (salaryFilter === 'Low') { // $0K - $69K
                        return jobSalaryMinK >= 0 && jobSalaryMinK < 70;
                    }
                    if (salaryFilter === 'Mid') { // $70K - $99K
                        return jobSalaryMinK >= 70 && jobSalaryMinK < 100;
                    }
                    if (salaryFilter === 'High') { // $100K+
                        return jobSalaryMinK >= 100;
                    }
                    return true;
                };

                return textMatch && locationMatch && salaryFilterMatch();
            });

            // Re-render the list with filtered results
            const jobListContainer = document.getElementById('job-list-container');
            if (jobListContainer) {
                jobListContainer.innerHTML = generateJobListingsHTML(filtered);
            }
        };
        window.filterJobs = filterJobs; // Expose to global scope for HTML onclick/onchange

        const generateJobListingsHTML = (jobArray) => {
            if (jobArray.length === 0) {
                return '<div class="text-center py-10 text-secondary-gray">No jobs match your current filters. Try broadening your search!</div>';
            }
            return jobArray.map(job => `
                <div class="bg-white p-6 rounded-xl card hover:shadow-xl hover:translate-y-[-2px] flex flex-col justify-between" role="listitem">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${job.title}</h3>
                        <p class="text-primary-blue font-semibold mb-2">${job.company}</p>
                        <div class="flex items-center space-x-4 text-sm text-secondary-gray mb-4">
                            <span class="flex items-center"><i class="fas fa-map-marker-alt mr-2"></i>${job.location}</span>
                            <span class="flex items-center"><i class="fas fa-money-bill-wave mr-2"></i>${job.salary}</span>
                        </div>
                        <p class="text-gray-700 line-clamp-3 mb-4">${job.description}</p>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button onclick="showApplyModal('${job.id}', '${job.title}')" class="btn-primary py-2 px-5 rounded-lg text-sm transition duration-150">
                            Apply Now
                        </button>
                    </div>
                </div>
            `).join('');
        };

        const renderJobs = () => {
            document.getElementById('navbar').classList.remove('hidden');
            // Populate location options dynamically from existing jobs
            const allLocations = [...new Set(window.jobs.map(j => j.location))];
            const locationOptions = allLocations.map(loc => `<option value="${loc}" ${currentJobFilter.location === loc ? 'selected' : ''}>${loc}</option>`).join('');

            document.getElementById('content-area').innerHTML = `
                <div class="p-4 sm:p-6 lg:p-8">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Job Listings</h1>
                    <p class="text-secondary-gray mb-8">Browse the latest job opportunities in the professional network.</p>

                    <!-- Filter Bar -->
                    <div class="bg-white p-6 rounded-xl card mb-8 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="search-input" class="block text-sm font-medium text-gray-700">Search Keywords (Title, Company, Description)</label>
                            <input type="text" id="search-input" oninput="filterJobs()" value="${currentJobFilter.search}" placeholder="e.g., React, Manager, Remote" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        </div>
                        
                        <div>
                            <label for="location-filter" class="block text-sm font-medium text-gray-700">Location</label>
                            <select id="location-filter" onchange="filterJobs()" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue bg-white">
                                <option value="All" ${currentJobFilter.location === 'All' ? 'selected' : ''}>All Locations</option>
                                ${locationOptions}
                            </select>
                        </div>
                        
                        <!-- NEW SALARY FILTER -->
                        <div>
                            <label for="salary-filter" class="block text-sm font-medium text-gray-700">Salary Range</label>
                            <select id="salary-filter" onchange="filterJobs()" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue bg-white">
                                <option value="All" ${currentJobFilter.salaryRange === 'All' ? 'selected' : ''}>Any Salary</option>
                                <option value="Low" ${currentJobFilter.salaryRange === 'Low' ? 'selected' : ''}>$0K - $70K</option>
                                <option value="Mid" ${currentJobFilter.salaryRange === 'Mid' ? 'selected' : ''}>$70K - $100K</option>
                                <option value="High" ${currentJobFilter.salaryRange === 'High' ? 'selected' : ''}>$100K+</option>
                            </select>
                        </div>

                        <!-- Clear Filter Button (Adjusted layout to fit new filter) -->
                        <div class="md:col-span-4 mt-2">
                             <button onclick="clearJobFilters()" class="text-sm text-secondary-gray hover:text-red-500 transition duration-150 p-2 rounded-lg border border-gray-300 hover:border-red-500 w-full md:w-auto">
                                Clear All Filters
                            </button>
                        </div>
                    </div>

                    <!-- Job List -->
                    <div id="job-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" role="list">
                        <!-- Jobs will be rendered here via filterJobs() or direct initial call -->
                    </div>
                </div>
            `;
            // Apply current filters on initial render
            filterJobs();
        };

        const renderPostJob = () => {
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('content-area').innerHTML = `
                <div class="p-4 sm:p-6 lg:p-8">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Post a New Job</h1>
                    <p class="text-secondary-gray mb-8">Fill in the details for the open position at your company.</p>

                    <div class="bg-white p-6 rounded-xl card max-w-3xl mx-auto">
                        <form onsubmit="handleJobPost(event)">
                            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                                <div>
                                    <label for="job-title" class="block text-sm font-medium text-gray-700">Job Title</label>
                                    <input type="text" id="job-title" placeholder="e.g., Data Scientist" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                                </div>
                                <div>
                                    <label for="company-name" class="block text-sm font-medium text-gray-700">Company Name</label>
                                    <input type="text" id="company-name" placeholder="e.g., Acme Solutions" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                                </div>
                                <div>
                                    <label for="job-location" class="block text-sm font-medium text-gray-700">Location</label>
                                    <input type="text" id="job-location" placeholder="e.g., Remote, London, NYC" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required>
                                </div>
                                <div>
                                    <label for="salary-range" class="block text-sm font-medium text-gray-700">Salary Range (e.g., $100K, Negotiable)</label>
                                    <input type="text" id="salary-range" placeholder="e.g., $120K - $150K or Negotiable" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="job-description" class="block text-sm font-medium text-gray-700">Job Description</label>
                                    <textarea id="job-description" rows="6" placeholder="Provide a detailed description of the role and requirements." class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue" required></textarea>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-end">
                                <button type="submit" class="btn-primary py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 font-semibold">
                                    Post Job
                                </button>
                            </div>
                        </form>
                    </div>
                    <div id="post-message" class="mt-4 text-green-600 font-semibold text-center hidden">Job posted successfully! Redirecting...</div>
                </div>
            `;
        };
        
        const renderNotifications = () => {
             document.getElementById('navbar').classList.remove('hidden');
             document.getElementById('content-area').innerHTML = `
                <div class="p-4 sm:p-6 lg:p-8 max-w-4xl mx-auto">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Notifications</h1>
                    <p class="text-secondary-gray mb-8">View recent activity and updates about your applications.</p>
                    
                    <div class="bg-white p-6 rounded-xl card space-y-4">
                        <div class="border-b pb-4">
                            <p class="font-semibold text-gray-800">Your application for 'UX Designer' at Design Studio has been viewed!</p>
                            <p class="text-sm text-secondary-gray mt-1 flex items-center"><i class="far fa-clock mr-2"></i>2 hours ago</p>
                        </div>
                        <div class="border-b pb-4">
                            <p class="font-semibold text-gray-800">Job Alert: New 'Marketing Manager' role matching your profile in London.</p>
                            <p class="text-sm text-secondary-gray mt-1 flex items-center"><i class="far fa-clock mr-2"></i>1 day ago</p>
                        </div>
                        <div class="border-b pb-4">
                            <p class="font-semibold text-gray-800">Welcome to JobConnect! Complete your profile to start applying.</p>
                            <p class="text-sm text-secondary-gray mt-1 flex items-center"><i class="far fa-clock mr-2"></i>3 days ago</p>
                        </div>
                        <p class="text-center text-secondary-gray pt-4">No older notifications.</p>
                    </div>
                </div>
             `;
        };
        
        const renderAbout = () => {
             document.getElementById('navbar').classList.remove('hidden');
             document.getElementById('content-area').innerHTML = `
                <div class="p-4 sm:p-6 lg:p-8 max-w-4xl mx-auto">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">About JobConnect</h1>
                    <div class="bg-white p-6 rounded-xl card space-y-4 text-gray-700">
                        <p>JobConnect is a Minimum Viable Product (MVP) designed to facilitate professional networking and job discovery in a secure, real-time environment using Firebase Firestore.</p>
                        <p class="font-semibold pt-2">Our Mission</p>
                        <p>To create a seamless, efficient platform that connects top talent with innovative companies, focusing on simplicity and user experience. This prototype demonstrates real-time data synchronization for job listings and applications.</p>
                        <p class="font-semibold pt-2">Key Features</p>
                        <ul class="list-disc list-inside space-y-1 pl-4 text-sm text-secondary-gray">
                            <li>Real-time Job Listings & Filtering.</li>
                            <li>Simple Profile Management for quick applications.</li>
                            <li>Secure Authentication (Simulated Email/Password for demo).</li>
                            <li>Collaborative environment enabled by shared User IDs.</li>
                        </ul>
                    </div>
                </div>
             `;
        };

        const renderContact = () => {
             document.getElementById('navbar').classList.remove('hidden');
             document.getElementById('content-area').innerHTML = `
                <div class="p-4 sm:p-6 lg:p-8 max-w-4xl mx-auto">
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Contact Us</h1>
                    <div class="bg-white p-6 rounded-xl card space-y-4 text-gray-700">
                        <p>We'd love to hear from you! Since this is an MVP, please use the following simulated contact information for inquiries.</p>
                        
                        <div class="space-y-3 pt-4">
                            <div class="flex items-center">
                                <i class="fas fa-envelope text-primary-blue w-6"></i>
                                <span class="ml-3 font-medium">Email:</span> <a href="mailto:support@jobconnect.com" class="ml-2 text-primary-blue hover:underline">support@jobconnect.com</a>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-phone-alt text-primary-blue w-6"></i>
                                <span class="ml-3 font-medium">Phone:</span> <span class="ml-2">(555) 123-4567</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-map-pin text-primary-blue w-6"></i>
                                <span class="ml-3 font-medium">Address:</span> <span class="ml-2">101 Innovation Drive, Tech City, Global</span>
                            </div>
                        </div>
                    </div>
                </div>
             `;
        };
        

        // --- Navigation and State Control ---

        const setUIState = (page) => {
            currentPage = page;
            switch (page) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'jobs':
                    renderJobs();
                    break;
                case 'profile':
                    renderProfile();
                    break;
                case 'postJob':
                    renderPostJob();
                    break;
                case 'notifications':
                    renderNotifications();
                    break;
                case 'about':
                    renderAbout();
                    break;
                case 'contact':
                    renderContact();
                    break;
                case 'login':
                default:
                    renderLogin();
                    break;
            }
            window.scrollTo(0, 0); // Scroll to top on navigation
        };

        window.navigateTo = (page) => {
            if (!isLoggedIn && page !== 'login') {
                setUIState('login');
                return;
            }
            setUIState(page);
        };


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>
</body>
</html>